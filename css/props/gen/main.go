// This file is part of YW project. Copyright 2025 Oh Inseo (YJK)
// SPDX-License-Identifier: BSD-3-Clause
// See LICENSE for details, and LICENSE_WHATWG_SPECS for WHATWG license information.

package main

import (
	"flag"
	"fmt"
	"go/format"
	"log"
	"os"
	"strconv"
	"strings"

	"github.com/inseo-oh/yw/css/internal/propsdef"
)

var requiredImports = []string{
	"fmt",
	"github.com/inseo-oh/yw/util",
	"github.com/inseo-oh/yw/css/csscolor",
	"github.com/inseo-oh/yw/css/box",
	"github.com/inseo-oh/yw/css/backgrounds",
	"github.com/inseo-oh/yw/css/values",
	"github.com/inseo-oh/yw/css/fonts",
	"github.com/inseo-oh/yw/css/sizing",
	"github.com/inseo-oh/yw/css/display",
	"github.com/inseo-oh/yw/css/text",
	"github.com/inseo-oh/yw/css/textdecor",
	"github.com/inseo-oh/yw/css/float",
}

var (
	pkg     = flag.String("pkg", "props", "Package name to use")
	outFile = flag.String("out", "props_data.go", "Output file")
)

func main() {
	flag.Parse()

	sb := strings.Builder{}
	log.SetPrefix("[css/props/gen] ")
	log.Println("Generating source code")
	sb.WriteString( /*      */ "// Auto-generated by css/props/gen\n// DO NOT EDIT.\n\n")
	sb.WriteString(fmt.Sprintf("package %s\n", *pkg))
	sb.WriteString( /*      */ "\n")
	sb.WriteString( /*      */ "import (\n")
	for _, imp := range requiredImports {
		sb.WriteString(fmt.Sprintf("\t%s\n", strconv.Quote(imp)))
	}
	sb.WriteString( /*      */ ")\n")
	sb.WriteString( /*      */ "\n")
	// Define shorthand struct and parser functions ----------------------------
	for _, prop := range propsdef.Props {
		sbInner := strings.Builder{}
		switch sh := prop.(type) {
		case propsdef.ShorthandSidesProp:
			sbInner.WriteString(fmt.Sprintf("type %s struct {\n", sh.TypeName(false)))
			sbInner.WriteString(fmt.Sprintf("\tTop    %s\n", sh.PropTop.PropType(false).TypeName))
			sbInner.WriteString(fmt.Sprintf("\tRight  %s\n", sh.PropRight.PropType(false).TypeName))
			sbInner.WriteString(fmt.Sprintf("\tBottom %s\n", sh.PropBottom.PropType(false).TypeName))
			sbInner.WriteString(fmt.Sprintf("\tLeft   %s\n", sh.PropLeft.PropType(false).TypeName))
			sbInner.WriteString( /*      */ "}\n")
			sbInner.WriteString( /*      */ "\n")
			sbInner.WriteString(fmt.Sprintf("func (sh %s) String() string {\n", sh.TypeName(false)))
			sbInner.WriteString( /*      */ "\treturn fmt.Sprintf(\"%v %v %v %v\", sh.Top, sh.Right, sh.Bottom, sh.Left)\n")
			sbInner.WriteString( /*      */ "}\n\n")
		case propsdef.ShorthandAnyProp:
			sbInner.WriteString(fmt.Sprintf("type %s struct {\n", sh.TypeName(false)))
			for _, prop := range sh.Props {
				sbInner.WriteString(fmt.Sprintf("\t%s %s\n", propsdef.GoIdentNameOfProp(prop), prop.PropType(false).TypeName))
			}
			sbInner.WriteString( /*      */ "}\n")
			sbInner.WriteString(fmt.Sprintf("func (sh %s) String() string {\n", sh.TypeName(false)))
			sbInner.WriteString(fmt.Sprintf("\treturn fmt.Sprintf(\"%s\",\n", strings.TrimSpace(strings.Repeat("%v ", len(sh.Props)))))
			for _, prop := range sh.Props {
				sbInner.WriteString(fmt.Sprintf("\t\tsh.%s,\n", propsdef.GoIdentNameOfProp(prop)))
			}
			sbInner.WriteString( /*      */ "\t)\n")
			sbInner.WriteString( /*      */ "}\n\n")
		}
		sb.WriteString(sbInner.String())
	}
	// Write property map ------------------------------------------------------
	sb.WriteString("var DescriptorsMap = map[string]Descriptor{\n")
	for _, prop := range propsdef.Props {
		sbInner := strings.Builder{}
		sbInner.WriteString(fmt.Sprintf("\t%s: {\n", strconv.Quote(prop.PropName())))
		sbInner.WriteString(fmt.Sprintf("\t\tInitial: %s,\n", prop.PropInitialValue(false)))
		sbInner.WriteString( /*      */ "\t\tApplyFunc: func(dest *ComputedStyleSet, value any) {\n")
		sbInner.WriteString(fmt.Sprintf("\t\t\tv := value.(%s)\n", prop.PropType(false).TypeName))
		sbInner.WriteString(fmt.Sprintf("\t\t\tdest.%sValue = &v\n", propsdef.GoIdentNameOfProp(prop)))
		switch sh := prop.(type) {
		case propsdef.ShorthandSidesProp:
			sbInner.WriteString(fmt.Sprintf("\t\t\tdest.%sValue = &v.Top\n", propsdef.GoIdentNameOfProp(sh.PropTop)))
			sbInner.WriteString(fmt.Sprintf("\t\t\tdest.%sValue = &v.Right\n", propsdef.GoIdentNameOfProp(sh.PropRight)))
			sbInner.WriteString(fmt.Sprintf("\t\t\tdest.%sValue = &v.Bottom\n", propsdef.GoIdentNameOfProp(sh.PropBottom)))
			sbInner.WriteString(fmt.Sprintf("\t\t\tdest.%sValue = &v.Left\n", propsdef.GoIdentNameOfProp(sh.PropLeft)))
		case propsdef.ShorthandAnyProp:
			for _, shProp := range sh.Props {
				sbInner.WriteString(fmt.Sprintf("\t\t\tdest.%sValue = &v.%s\n", propsdef.GoIdentNameOfProp(shProp), propsdef.GoIdentNameOfProp(shProp)))
			}
		}
		sbInner.WriteString( /*      */ "\t\t},\n")
		sbInner.WriteString( /*      */ "\t},\n")
		sb.WriteString(sbInner.String())
	}
	sb.WriteString("}\n\n")
	// Write ComputedStyleSet struct -------------------------------------------
	sb.WriteString("type ComputedStyleSet struct {\n")
	for _, prop := range propsdef.Props {
		sbInner := strings.Builder{}
		sbInner.WriteString(fmt.Sprintf("\t%sValue *%s\n", propsdef.GoIdentNameOfProp(prop), prop.PropType(false).TypeName))
		sb.WriteString(sbInner.String())
	}
	sb.WriteString("}\n")
	sb.WriteString("\n")
	// Write ComputedStyleSet methods ------------------------------------------
	for _, prop := range propsdef.Props {
		sbInner := strings.Builder{}
		if !prop.IsShorthand() {
			sbInner.WriteString(fmt.Sprintf("func (css *ComputedStyleSet) %s() %s {\n", propsdef.GoIdentNameOfProp(prop), prop.PropType(false).TypeName))
			sbInner.WriteString(fmt.Sprintf("\tif css.%sValue == nil {\n", propsdef.GoIdentNameOfProp(prop)))
			sbInner.WriteString(fmt.Sprintf("\t\tinitial := DescriptorsMap[%s].Initial.(%s)\n", strconv.Quote(prop.PropName()), prop.PropType(false).TypeName))
			sbInner.WriteString(fmt.Sprintf("\t\tcss.%sValue = &initial\n", propsdef.GoIdentNameOfProp(prop)))
			sbInner.WriteString( /*      */ "\t}\n")
			sbInner.WriteString( /*      */ fmt.Sprintf("\treturn *css.%sValue\n", propsdef.GoIdentNameOfProp(prop)))
			sbInner.WriteString( /*      */ "}\n")
		}
		if prop.IsInheritable() {
			sbInner.WriteString(fmt.Sprintf("func (css *ComputedStyleSet) inherit%sFromParent(parentSrc ComputedStyleSetSource) {\n", propsdef.GoIdentNameOfProp(prop)))
			sbInner.WriteString( /*      */ "\tparentCss := parentSrc.ComputedStyleSet()\n")
			sbInner.WriteString(fmt.Sprintf("\tif !util.IsNil(parentCss.%sValue) {\n", propsdef.GoIdentNameOfProp(prop)))
			switch sh := prop.(type) {
			case propsdef.ShorthandSidesProp:
				sbInner.WriteString(fmt.Sprintf("\t\t\tcss.%sValue = &parentCss.%sValue.Top\n", propsdef.GoIdentNameOfProp(sh.PropTop), propsdef.GoIdentNameOfProp(prop)))
				sbInner.WriteString(fmt.Sprintf("\t\t\tcss.%sValue = &parentCss.%sValue.Right\n", propsdef.GoIdentNameOfProp(sh.PropRight), propsdef.GoIdentNameOfProp(prop)))
				sbInner.WriteString(fmt.Sprintf("\t\t\tcss.%sValue = &parentCss.%sValue.Bottom\n", propsdef.GoIdentNameOfProp(sh.PropBottom), propsdef.GoIdentNameOfProp(prop)))
				sbInner.WriteString(fmt.Sprintf("\t\t\tcss.%sValue = &parentCss.%sValue.Left\n", propsdef.GoIdentNameOfProp(sh.PropLeft), propsdef.GoIdentNameOfProp(prop)))
			case propsdef.ShorthandAnyProp:
				for _, shProp := range sh.Props {
					sbInner.WriteString(fmt.Sprintf("\t\t\tcss.%sValue = &parentCss.%sValue.%s\n", propsdef.GoIdentNameOfProp(shProp), propsdef.GoIdentNameOfProp(prop), propsdef.GoIdentNameOfProp(shProp)))
				}
			}
			sbInner.WriteString(fmt.Sprintf("\t\tcss.%sValue = parentCss.%sValue\n", propsdef.GoIdentNameOfProp(prop), propsdef.GoIdentNameOfProp(prop)))
			sbInner.WriteString( /*      */ "\t} else if parentParentSrc := parentSrc.ParentSource(); !util.IsNil(parentParentSrc) {\n")
			sbInner.WriteString(fmt.Sprintf("\t\tcss.inherit%sFromParent(parentParentSrc)\n", propsdef.GoIdentNameOfProp(prop)))
			sbInner.WriteString( /*      */ "\t}\n")
			sbInner.WriteString( /*      */ "}\n")
		}
		sb.WriteString(sbInner.String())
	}
	sb.WriteString( /*      */ "func (css *ComputedStyleSet) InheritPropertiesFromParent(parentSrc ComputedStyleSetSource) {\n")
	for _, prop := range propsdef.Props {
		sbInner := strings.Builder{}
		if prop.IsInheritable() {
			sbInner.WriteString(fmt.Sprintf("\tif util.IsNil(css.%sValue) {\n", propsdef.GoIdentNameOfProp(prop)))
			sbInner.WriteString(fmt.Sprintf("\t\tcss.inherit%sFromParent(parentSrc)\n", propsdef.GoIdentNameOfProp(prop)))
			sbInner.WriteString( /*      */ "\t}\n")
		}
		sb.WriteString(sbInner.String())
	}
	sb.WriteString( /*      */ "}\n")
	log.Printf("Formatting generated source")
	unformatted := []byte(sb.String())
	formatted, err := format.Source(unformatted)
	if err != nil {
		log.Println(err)
		log.Println("Formatting error -- Writing unformatted source code instead")
		formatted = unformatted
	}
	log.Printf("Writing output to %s", *outFile)
	err = os.WriteFile(*outFile, formatted, 0644)
	if err != nil {
		log.Fatal(err)
	}
}
